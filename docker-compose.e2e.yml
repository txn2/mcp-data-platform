# E2E Test Environment for MCP Data Platform
#
# This compose file provides platform services (Trino, SeaweedFS, PostgreSQL).
# DataHub should be started separately via: datahub docker quickstart
#
# Usage:
#   docker compose -f docker-compose.e2e.yml up -d
#
# Prerequisites:
#   - DataHub CLI: pip install acryl-datahub
#   - DataHub running: datahub docker quickstart

services:
  # PostgreSQL for OAuth/Audit storage
  postgres:
    image: postgres:16-alpine
    container_name: e2e-postgres
    environment:
      POSTGRES_USER: platform
      POSTGRES_PASSWORD: platform_secret
      POSTGRES_DB: mcp_platform
    ports:
      - "5432:5432"
    volumes:
      - ./test/e2e/init/postgres:/docker-entrypoint-initdb.d:ro
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U platform -d mcp_platform"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - e2e-network

  # Trino for query execution
  trino:
    image: trinodb/trino:453
    container_name: e2e-trino
    ports:
      - "8090:8080"
    volumes:
      - ./test/e2e/init/trino/catalog:/etc/trino/catalog:ro
      - ./test/e2e/init/trino/etc/config.properties:/etc/trino/config.properties:ro
    healthcheck:
      test: ["CMD", "trino", "--execute", "SELECT 1"]
      interval: 10s
      timeout: 10s
      retries: 30
      start_period: 30s
    networks:
      - e2e-network

  # SeaweedFS for S3-compatible storage
  seaweedfs:
    image: chrislusf/seaweedfs:latest
    container_name: e2e-seaweedfs
    command: "server -s3 -s3.port=8333 -s3.config=/etc/seaweedfs/s3.json -master.dir=/data/master -volume.dir=/data/volume -volume.max=5"
    ports:
      - "9000:8333"   # S3 API (mapped to 9000 for compatibility with existing config)
      - "9333:9333"   # Master
    volumes:
      - seaweedfs_data:/data
      - ./test/e2e/init/seaweedfs/s3.json:/etc/seaweedfs/s3.json:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9333/cluster/status"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - e2e-network

  # SeaweedFS setup - creates buckets and uploads test data
  seaweedfs-setup:
    image: amazon/aws-cli:latest
    container_name: e2e-seaweedfs-setup
    depends_on:
      seaweedfs:
        condition: service_healthy
    environment:
      AWS_ACCESS_KEY_ID: admin
      AWS_SECRET_ACCESS_KEY: admin_secret
      AWS_DEFAULT_REGION: us-east-1
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      aws --endpoint-url http://seaweedfs:8333 s3 mb s3://test-data-lake || true;
      aws --endpoint-url http://seaweedfs:8333 s3 mb s3://test-analytics || true;
      aws --endpoint-url http://seaweedfs:8333 s3 cp /testdata/sample.parquet s3://test-data-lake/raw/sample.parquet;
      echo 'SeaweedFS setup complete';
      "
    volumes:
      - ./test/e2e/testdata/s3:/testdata:ro
    networks:
      - e2e-network

  # Trino setup - creates test tables
  trino-setup:
    image: trinodb/trino:453
    container_name: e2e-trino-setup
    depends_on:
      trino:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      trino --server http://trino:8080 --file /setup/setup.sql;
      echo 'Trino setup complete';
      "
    volumes:
      - ./test/e2e/init/trino/setup.sql:/setup/setup.sql:ro
    networks:
      - e2e-network

volumes:
  postgres_data:
  seaweedfs_data:

networks:
  e2e-network:
    driver: bridge
