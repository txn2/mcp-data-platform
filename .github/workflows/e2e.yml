name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e-platform-services:
    name: E2E Tests (Platform Services)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: platform
          POSTGRES_PASSWORD: platform_secret
          POSTGRES_DB: mcp_platform
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U platform -d mcp_platform"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      trino:
        image: trinodb/trino:453
        ports:
          - 8090:8080
        options: >-
          --health-cmd "trino --execute 'SELECT 1'"
          --health-interval 15s
          --health-timeout 10s
          --health-retries 20
          --health-start-period 60s

      minio:
        image: minio/minio:latest
        env:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin123
        ports:
          - 9000:9000
          - 9001:9001
        options: >-
          --health-cmd "mc ready local || curl -sf http://localhost:9000/minio/health/live"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for PostgreSQL..."
          until pg_isready -h localhost -p 5432 -U platform; do
            sleep 2
          done
          echo "PostgreSQL is ready!"

          echo "Waiting for Trino..."
          for i in {1..30}; do
            if curl -sf http://localhost:8090/v1/info > /dev/null; then
              echo "Trino is ready!"
              break
            fi
            echo "Waiting for Trino... ($i/30)"
            sleep 5
          done

          echo "Waiting for MinIO..."
          until curl -sf http://localhost:9000/minio/health/live > /dev/null; do
            sleep 2
          done
          echo "MinIO is ready!"

      - name: Setup MinIO buckets
        run: |
          # Install mc (MinIO client)
          wget -q https://dl.min.io/client/mc/release/linux-amd64/mc
          chmod +x mc

          # Configure mc
          ./mc alias set local http://localhost:9000 minioadmin minioadmin123

          # Create test buckets
          ./mc mb --ignore-existing local/test-data-lake
          ./mc mb --ignore-existing local/test-analytics

          # Upload test data
          ./mc cp test/e2e/testdata/s3/sample.parquet local/test-data-lake/raw/

          echo "MinIO setup complete!"

      - name: Setup Trino tables
        run: |
          # Wait a bit more for Trino to be fully ready
          sleep 10

          # Create test schema and tables
          docker run --rm --network host trinodb/trino:453 \
            trino --server http://localhost:8090 \
            --execute "CREATE SCHEMA IF NOT EXISTS memory.e2e_test"

          # Create and populate test tables
          docker run --rm --network host trinodb/trino:453 \
            trino --server http://localhost:8090 \
            --execute "
              CREATE TABLE IF NOT EXISTS memory.e2e_test.test_orders (
                order_id BIGINT,
                customer_id BIGINT,
                order_date DATE,
                total_amount DECIMAL(10, 2),
                status VARCHAR(50)
              )
            "

          docker run --rm --network host trinodb/trino:453 \
            trino --server http://localhost:8090 \
            --execute "
              INSERT INTO memory.e2e_test.test_orders VALUES
                (1, 100, DATE '2024-01-15', 150.00, 'completed'),
                (2, 101, DATE '2024-01-16', 250.50, 'completed')
            "

          docker run --rm --network host trinodb/trino:453 \
            trino --server http://localhost:8090 \
            --execute "
              CREATE TABLE IF NOT EXISTS memory.e2e_test.legacy_users (
                user_id BIGINT,
                username VARCHAR(100),
                email VARCHAR(255),
                created_at TIMESTAMP
              )
            "

          docker run --rm --network host trinodb/trino:453 \
            trino --server http://localhost:8090 \
            --execute "
              CREATE TABLE IF NOT EXISTS memory.e2e_test.products (
                product_id BIGINT,
                name VARCHAR(255),
                price DECIMAL(10, 2),
                category VARCHAR(100)
              )
            "

          docker run --rm --network host trinodb/trino:453 \
            trino --server http://localhost:8090 \
            --execute "
              CREATE TABLE IF NOT EXISTS memory.e2e_test.customer_metrics (
                customer_id BIGINT,
                total_orders INTEGER,
                total_spent DECIMAL(12, 2),
                first_order_date DATE,
                last_order_date DATE
              )
            "

          echo "Trino setup complete!"

      - name: Run E2E tests (without DataHub)
        env:
          E2E_TRINO_HOST: localhost
          E2E_TRINO_PORT: 8090
          E2E_POSTGRES_DSN: postgres://platform:platform_secret@localhost:5432/mcp_platform?sslmode=disable
          E2E_MINIO_ENDPOINT: localhost:9000
          E2E_MINIO_ACCESS_KEY: minioadmin
          E2E_MINIO_SECRET_KEY: minioadmin123
          E2E_DATAHUB_URL: ""  # DataHub not available in this job
        run: |
          go test -v -race -tags=integration ./test/e2e/... 2>&1 | tee e2e-test-output.log

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-logs
          path: e2e-test-output.log
          retention-days: 7

  # Optional: Full E2E with DataHub (requires more resources)
  # Uncomment and configure for full integration testing
  # e2e-with-datahub:
  #   name: E2E Tests (Full with DataHub)
  #   runs-on: ubuntu-latest-8-cores  # Requires larger runner
  #   timeout-minutes: 45
  #   if: github.event_name == 'workflow_dispatch'
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Set up Python for DataHub CLI
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.11'
  #
  #     - name: Install DataHub CLI
  #       run: pip install acryl-datahub
  #
  #     - name: Start DataHub
  #       run: |
  #         datahub docker quickstart --detach
  #         sleep 180  # Wait for DataHub to fully start
  #
  #     - name: Start Platform Services
  #       run: docker compose -f docker-compose.e2e.yml up -d
  #
  #     - name: Wait for all services
  #       run: ./scripts/wait-for-services.sh
  #
  #     - name: Seed DataHub
  #       run: make e2e-seed
  #
  #     - name: Run full E2E tests
  #       run: make e2e-test
  #
  #     - name: Cleanup
  #       if: always()
  #       run: |
  #         make e2e-down
  #         datahub docker nuke
